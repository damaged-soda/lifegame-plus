# 方向不等价规则体系（上下语义）技术变更计划（Plan）

## 0. 背景与目标（简短即可）
- 背景：
  - 当前规则体系是 Life-like（`B.../S...` + 邻居数量 `n`），隐含“八方向等价/各向同性”的假设。
  - 现在需要一个“上下不对称”的场景：方向不等价（N/S 等方位有语义），并且“越往上越高级”的叙事需要一个明确的“上/下”方向。
- 目标：
  - 新规则体系支持**方向敏感**：规则依赖邻居的具体方位（不再只看数量 `n`）。
  - 保留 A/B/C 三种元胞类型与叠加（bitmask），并保持：
    - 三类型**共用一套规则**
    - 每种类型只看同类型邻居独立演化（无跨类型影响）
  - 边界改为：**左右环绕、上下不环绕**（越界视为“空”）。
  - 删除旧规则体系与 UI：移除 `B.../S...`、旧预设规则集、`n=0..8` 原子规则勾选。
  - 提供新的右侧规则面板：可视化展示“方向规则”（3×3 前态 → 后态），并在暂停时可切换/启用规则。
- 非目标：
  - 暂不引入跨类型影响/转换（例如 A 产生 B、A 与 B 交互等）。
  - 暂不做“按高度 y 不同应用不同规则”的分层规则（当前只做方向敏感；高度分层可作为后续扩展）。
  - 暂不做棋盘编辑/画笔（保持上个版本结论）。

## 1. 影响范围（必须）
- 影响的 repo（来自 docmap，可多项）：lifegame-plus
- 影响的模块/目录/文件（按 repo 分组列出即可）：
  - repo: lifegame-plus
    - `src/lifegame-plus/engine/lifegame.js`（边界策略、规则数据结构、演进算法）
    - `src/lifegame-plus/web/index.html`（规则面板结构与文案）
    - `src/lifegame-plus/web/main.js`（规则面板逻辑、规则表示/切换、渲染与控制逻辑对接）
    - `src/lifegame-plus/web/style.css`（新规则卡片样式；删除旧原子规则样式若不再使用）
- 外部可见变化（如适用：API/CLI/配置/数据格式）：
  - 规则展示与配置方式全面替换（不再出现 `B.../S...` 与旧预设）。
  - 边界从“上下左右环绕”变为“左右环绕、上下不环绕”。

## 2. 方案与改动点（必须）
说明：实现将按批次推进；每批次写入前需先列出本批次改动文件/影响并征求确认。

### 2.1 新规则模型（方向敏感）
为保证可视化与可组合性，采用“模式匹配规则”：

- 规则以 3×3 邻域为视觉载体，但匹配只针对**同类型层的二值占用**（活/空）。
- 规则分为两组（类似 Birth/Survive，但不使用 `n`）：
  - `birthRules`：中心为“空”时，若任一规则匹配，则下一步中心变“活”
  - `surviveRules`：中心为“活”时，若任一规则匹配，则下一步中心保持“活”
- 若无规则匹配：默认下一步为“空”（与当前“默认死”一致）。

**规则的匹配表示（建议）**
- 使用 8 邻居位序（方向固定，不等价）：
  - N, NE, E, SE, S, SW, W, NW（共 8 位）
- 每条规则用两个 bitmask 表达约束（可视化仍是 3×3）：
  - `mustAliveMask`：这些方向必须为“活”
  - `mustDeadMask`：这些方向必须为“空”
  - 未在两者中的方向为“不关心”（允许活/空）
- 匹配判定：`(neighborsMask & mustAliveMask) === mustAliveMask && (neighborsMask & mustDeadMask) === 0`

> 注：该表示天然支持“上下不对称”（例如只要求 S/SW/SE 为活，表达“从下往上长”）。

### 2.2 A/B/C 多类型与共用规则
- 规则对三类型共用：同一份 `birthRules/surviveRules` 同时应用于 A、B、C。
- 仍保持“只看同类型邻居”：计算 `neighborsMask` 时，只统计目标类型位（A 只看 A，B 只看 B，C 只看 C）。

### 2.3 边界策略（左右环绕、上下不环绕）
- X 方向仍使用环绕索引（toroidal in X）。
- Y 方向不环绕：`y=-1` 或 `y=height` 的邻居视为“空”。
- 种子放置也遵循该边界：X 超界环绕；Y 超界则忽略该点（不落子）。

### 2.4 Web 规则面板替换（删除旧规则）
- 删除/替换内容：
  - 旧规则集下拉（Conway/HighLife/...）与 `B.../S...` 规则文本
  - 旧原子规则（`n=0..8` 出生/存活勾选）与其 A/B 术语
- 新规则面板（建议 MVP）：
  - `规则集` 下拉：只保留**少量**面向“方向不等价”的规则集（例如“向上生长”“向上漂移”），不再沿用 Life-like 预设
  - 展示规则列表：每条规则为一张可视化卡片（3×3 前态 → 后态），并有复选框启用/停用
  - 交互约束：播放中禁用规则面板；仅暂停允许切换规则/启用规则

> 说明：这里的“规则集”是“多条方向规则的集合”，用于快速切换；与“单条原子规则”区分开。

### 2.5 分批次实施（建议）
- 批次 1（Engine 基建）：
  - 引擎新增方向规则数据结构与匹配/编译缓存
  - `step` 改用方向规则演进
  - 边界策略改为“左右环绕、上下不环绕”
- 批次 2（Web UI 替换）：
  - 移除旧规则 UI（B/S、旧预设、n 卡片）
  - 新规则面板：规则集下拉 + 规则列表（可视化卡片 + 启用勾选）
  - Web 与 engine 对接新规则结构
- 批次 3（体验打磨）：
  - 调整默认规则集与默认初始种子，使“向上=高级/更活跃”的观感更明显
  - 完善文案与可视化（比如规则卡片中明确标注“上/下/左/右”）

## 3. 自测与验收口径（必须，可执行）
- 本地自测步骤（命令/操作）：
  1) `python3 -m http.server 8000`
  2) 打开 `http://127.0.0.1:8000/src/lifegame-plus/web/`
  3) 验证边界：左右环绕、上下不环绕（靠近顶部的结构不会从底部“回流”）
  4) 暂停后切换规则集/启用规则；播放后观察行为明显呈现“上/下不对称”
- 关键用例清单：
  - 边界：在顶部边缘附近生成结构，演进不应从底部出现对应结构（Y 不环绕）
  - 方向性：同一初始图案，翻转上下（或旋转 180°）后演进结果应明显不同（规则方向敏感）
  - 三类型一致：A/B/C 在同一规则下应呈现同类行为（因共用规则且只看同类型）
  - 暂停约束：播放中无法改规则；暂停后可切换并立即生效
- 通过标准：
  - UI 不再出现 `B.../S...`、旧预设、`n=0..8` 原子规则卡片
  - 引擎边界为“左右环绕、上下不环绕”
  - 引擎规则依赖方向（非各向同性）：上下翻转/旋转后行为可区分
  - A/B/C 保持独立演化且共用同一套方向规则

- 自测记录（2026-01-11）：
  - `node --check src/lifegame-plus/engine/lifegame.js`（通过）
  - `node --check src/lifegame-plus/web/main.js`（通过）
  - 按本节步骤在浏览器中手工验证（用户验收通过）

交付摘要口径（固定）：实现完成后，必须输出交付摘要，包含：
- 实际改动清单（按 repo 列出关键文件/模块）
- 自测步骤与结果
- 对照本节“通过标准”的逐条结论
- 已知风险/未决事项（如有必须列出）

约束：用户验收通过前，不更新 SOT，不归档 WIP。

## 4. SOT 更新清单（必须）
用户验收通过后，要把“最终事实”沉淀到 SOT：

- `docs/sot/overview.md`：更新规则体系与边界策略；更新 UI 入口说明
- `docs/sot/architecture.md`：更新引擎规则数据结构（方向规则）、边界策略与模块约束

## 5. 完成后归档动作（固定）
实现完成并完成基本自测后：
1) 输出交付摘要并请求用户验收
2) 用户验收通过后，按第 4 节更新 SOT
3) 更新第 6 节检查单（必须全勾）
4) 将整个目录从 `docs/wip/20260111-asymmetric-rules/` 移动到 `docs/archive/20260111-asymmetric-rules/`

## 6. WIP 检查单（必须全勾才能归档）
- [x] plan.md 已确认（PLAN 闸门已通过）
- [x] 代码改动已完成（IMPLEMENT 完成）
- [x] 基本自测已完成（记录命令/步骤与结果）
- [x] 已输出交付摘要并且用户验收通过（VERIFY 闸门已通过）
- [x] SOT 已更新（按第 4 节执行；`docs/sot/overview.md`、`docs/sot/architecture.md`）
- [x] 已归档：wip → archive（目录已移动到 `docs/archive/20260111-asymmetric-rules/`）
