# 元规则（互斥 / 到顶结束）技术变更计划（Plan）

## 0. 背景与目标（简短即可）
- 背景：当前 A/B/C 允许同格叠加，且无“结束条件”，希望增加两条可选“元规则”来约束玩法与结束判定。
- 目标：
  - 增加可选元规则 1：A/B/C 单格互斥（同一格最多一种类型；若存在冲突则随机裁决）
  - 增加可选元规则 2：任一类型到达最顶端（`y=height-1`）则游戏结束（自动停止播放并提示；不允许继续播放）
  - 两条元规则均可在 UI 中开关（默认关闭），且仅在暂停时可调整（沿用现有规则面板约束）
- 非目标：
  - 不新增棋盘编辑能力
  - 不改变现有方向规则语义（默认存活 + 概率出生）
  - 不新增后端/存储/部署相关内容

约定（已由用户确认）：
1) 同一步可能出现多种类型时：使用现有 PRNG 做随机裁决（可复现）。
2) 允许“本步死亡后，其他类型在同一步填入”。
3) 触发“到顶结束”后：不允许继续播放；仅能通过 `重置/重试/修改 seed 生效并重新初始化` 重新开始。

## 1. 影响范围（必须）
- 影响的 repo（来自 docmap，可多项）：`lifegame-plus`
- 影响的模块/目录/文件（按 repo 分组列出即可）：
  - `src/lifegame-plus/engine/lifegame.js`
  - `src/lifegame-plus/web/index.html`
  - `src/lifegame-plus/web/main.js`
  - `src/lifegame-plus/web/style.css`（如需新增“元规则”区块样式）
- 外部可见变化（如适用：API/CLI/配置/数据格式）：
  - Web UI 增加“元规则”开关项
  - 当开启“到顶结束”并触发时，播放会自动停止；`播放` 按钮禁用并提示结束原因
  - 当开启“单格互斥”时，演进结果不再出现同格多类型；开启瞬间会对存量叠加做一次规整

## 2. 方案与改动点（必须）
说明：实现将按批次推进；每批次写入前需先列出本批次改动文件/影响并征求确认。

按 repo 分组写清楚“要改什么”，不写部署流程：

- repo: lifegame-plus
  - 改动点：
    - 引擎：为 `stepDirectional` 增加可选“元规则”参数/字段；开启“单格互斥”时执行互斥裁决（含随机冲突处理与“死亡后可填入”语义）
    - Web：规则面板新增“元规则”区块（checkbox），将开关状态传给引擎
    - Web：当开启“到顶结束”时，在步进后检测顶行；触发则停止播放并进入“结束态”（禁用继续播放）
    - Web：开启互斥时若盘面存在同格多类型，立即按 PRNG 随机规整为单类型并重绘
  - 新增/修改的接口或数据结构：
    - `stepDirectional(grid, ruleSet, rng, metaRules?) -> newGrid`（新增可选第 4 参；不影响现有 2/3 参调用）
    - `metaRules`（草案）：
      - `exclusiveCell: boolean`（单格互斥；默认 `false`）
  - 关键逻辑说明：
    - 单格互斥（开启时）：
      - 每格在任一时刻最多一种类型；若出现冲突则随机裁决（使用传入的 `rng`，确保可复现）
      - “已有则不能进入”的时间语义：若 t 时刻该格有类型且其在 t+1 存活，则其他类型 t+1 不能进入（不评估其出生）
      - “死亡后可填入”：若 t 时刻类型在 t+1 死亡，则该格可在同一步按“空格出生”逻辑让其他类型进入（若多种同时满足则随机选 1）
      - 为兼容历史盘面：当用户在 UI 打开互斥开关时，会立即对当前盘面中“多类型叠加”的格子做一次随机规整
    - 到顶结束（Web 侧）：
      - 每次 `stepDirectional` 后检查 `y=height-1` 行是否存在任一类型位；若存在则：
        - 自动停止播放
        - 展示“游戏结束：<到顶类型集合>”
        - 禁用继续播放，直到 `重置/重试/修改 seed 重新初始化`

## 3. 自测与验收口径（必须，可执行）
- 本地自测步骤（命令/操作）：
  - `python3 -m http.server 8000`
  - 打开 `http://127.0.0.1:8000/src/lifegame-plus/web/`
  - 在暂停态切换元规则开关，点击播放观察行为；触发结束后用 `重置/重试/改 seed` 重新开始
- 关键用例清单：
  - 互斥关闭：行为与当前一致（允许同格叠加；渲染仍支持多类型）
  - 互斥开启：
    - 开启瞬间：若存在同格多类型，立即被随机规整为单类型（可复现：同 seed + 同操作序列）
    - 演进过程中：不再出现同格多类型
    - “死亡后可填入”生效：占用格在本步死亡时，其他类型可在同一步出生并占用该格
  - 到顶结束开启：
    - 任一类型到达顶行时自动停止播放并提示
    - 触发后无法继续播放；`重置/重试/改 seed` 可重新开始
- 通过标准：
  - 两条元规则均为可选，默认关闭不改变现有演进与 UI 交互
  - 开启互斥后，任意时刻同格最多一种类型
  - 开启到顶结束后，触发时稳定停止播放并进入不可继续播放的结束态

交付摘要口径（固定）：实现完成后，必须输出交付摘要，包含：
- 实际改动清单（按 repo 列出关键文件/模块）
- 自测步骤与结果
- 对照本节“通过标准”的逐条结论
- 已知风险/未决事项（如有必须列出）

约束：用户验收通过前，不更新 SOT，不归档 WIP。

## 4. SOT 更新清单（必须）
用户验收通过后，要把“最终事实”沉淀到 SOT（至少文件级，V1 不要求精确到小节）：

- `docs/sot/overview.md`：补充“元规则（互斥/到顶结束）”能力；将“同格可叠加”改为“默认可叠加，但可开启单格互斥”
- `docs/sot/architecture.md`：补充 `stepDirectional` 新增的 `metaRules` 参数及互斥语义；补充 Web 侧到顶结束检测与结束态处理

## 5. 完成后归档动作（固定）
实现完成并完成基本自测后：
1) 输出交付摘要并请求用户验收
2) 用户验收通过后，按第 4 节更新 SOT
3) 更新第 6 节检查单（必须全勾）
4) 将整个目录从 `docs/wip/20260112-meta-rules/` 移动到 `docs/archive/20260112-meta-rules/`

## 6. WIP 检查单（必须全勾才能归档）
- [x] plan.md 已确认（PLAN 闸门已通过）
- [x] 代码改动已完成（IMPLEMENT 完成）
- [x] 基本自测已完成：`node --input-type=module` 引擎导入与断言；浏览器打开页面并手动验证互斥/到顶结束交互
- [x] 已输出交付摘要并且用户验收通过（VERIFY 闸门已通过）
- [x] SOT 已更新：`docs/sot/overview.md`、`docs/sot/architecture.md`
- [x] 已归档：wip → archive（目录已移动）
