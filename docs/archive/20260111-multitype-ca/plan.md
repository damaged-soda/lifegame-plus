# 多类型多层元胞自动机（A/B/C）技术变更计划（Plan）

## 0. 背景与目标（简短即可）
- 背景：当前实现是单层二值（生/死）的 Life-like 规则；现在要对齐草稿模型，引入 A/B/C 三种元胞类型，并允许同一格叠加多个类型（多层）。
- 目标：
  - 支持三种元胞类型 A/B/C（可叠加）；每个类型只看同类型邻居，互不影响。
  - A/B/C 共用一套演化规则（Life-like：`B.../S...`），同一格可出现多个类型“同时出生”。
  - 右侧规则面板继续存在：规则集下拉 + 原子规则可视化；仅暂停时可编辑规则（播放中禁用）。
  - Canvas 显示采用“三色分布”：
    - 仅单类型：居中显示该颜色
    - 多类型叠加：在格子内均匀分布显示（固定位置）
  - 初始盘面：A/B/C 各放一组固定种子图案，位置随机（每次刷新页面随机一次）。
- 非目标：
  - 暂不做 A/B/C 的跨类型相互影响（只做 A→A、B→B、C→C）。
  - 暂不做可视化自定义规则编辑器（仍以 Life-like 的 `B.../S...` 与原子规则勾选为主）。
  - 暂不做“棋盘编辑/画笔”能力（后续再加）。
  - 暂不做存档/导入导出/分享链接等能力。

## 1. 影响范围（必须）
- 影响的 repo（来自 docmap，可多项）：lifegame-plus
- 影响的模块/目录/文件（按 repo 分组列出即可）：
  - repo: lifegame-plus
    - `src/lifegame-plus/engine/lifegame.js`（网格数据结构、演进算法、种子 API）
    - `src/lifegame-plus/web/index.html`（文案消歧）
    - `src/lifegame-plus/web/main.js`（渲染、交互、随机初始化）
    - `src/lifegame-plus/web/style.css`（三色分布显示相关样式，如需要）
- 外部可见变化（如适用：API/CLI/配置/数据格式）：
  - 画布渲染从黑白像素变为三色分布显示（单类型居中、多类型均匀分布）。
  - 页面初始不再固定 glider：改为 A/B/C 各一组种子，随机位置。
  - 原子规则卡片将不再使用 “A→B” 术语，避免与元胞类型 A/B/C 冲突。

## 2. 方案与改动点（必须）
说明：实现将按批次推进；每批次写入前需先列出本批次改动文件/影响并征求确认。

### 核心数据结构
- 类型位：`A=1`、`B=2`、`C=4`；同一格可叠加（`cells[i]` 取值范围 `0..7`）。
- 网格结构保持：`grid = { width, height, cells: Uint8Array }`，但 `cells` 从二值变为 bitmask。
- 规则结构保持：`rule = { birth: number[], survive: number[] }`（`B.../S...`），A/B/C 共用同一套。

### 演进语义（对齐草稿模型）
- 对每个类型 `t ∈ {A,B,C}`：
  - 邻居计数只统计同类型：`neighbors_t = count( neighborCell & t )`。
  - 下一步只影响同类型位：`t` 的出生/存活由共享 `B.../S...` 决定。
- 同一格上多个类型独立计算；若多个类型都满足出生条件，则这些类型同时出现（bitmask 叠加）。

### 渲染语义（三色分布）
说明：渲染以“单类型居中、多类型均匀分布”为主，避免颜色混合导致不可辨识。

- 单类型：居中显示该类型颜色（可用一个小十字形点阵加强可见性）
- 多类型：在一个格子内按固定位置分布显示，建议：
  - A：上中（例如黄色）
  - B：右下（例如绿色）
  - C：左下（例如青色）

### 随机初始化（A/B/C 各一组）
- 为 A/B/C 各定义一个固定种子图案（与草稿对应），在随机位置放置：
  - 随机子 A：竖向 5 连
  - 随机子 B：横向 5 连
  - 随机子 C：glider（5 格）
- 随机位置用 `Math.random()`；放置时使用环绕索引，允许靠边生成并自然跨边界。

### UI/术语消歧
- 原子规则卡片不再出现 “A→B” 术语，改用“前态→后态”（或“空→有/有→有”）来表达规则含义，避免与元胞类型 A/B/C 冲突。
- 保持交互约束：播放中禁用规则面板；仅暂停时允许切换规则。

### 分批次实施（建议）
- 批次 1（Engine）：把 `cells` 升级为 bitmask；实现 A/B/C 独立演进；补齐 A/B/C 种子 API。
- 批次 2（Render）：Canvas 渲染改为三色分布显示（单类型居中、多类型均匀分布）。
- 批次 3（Init + 文案）：初始随机种子；原子规则卡片文案消歧（不做棋盘编辑/画笔）。

## 3. 自测与验收口径（必须，可执行）
- 本地自测步骤（命令/操作）：
  1) `python3 -m http.server 8000`
  2) 打开 `http://127.0.0.1:8000/src/lifegame-plus/web/`
  3) 观察初始盘面出现 A/B/C 三组种子（位置随机），颜色分布符合 A/B/C 映射
  4) `播放/暂停`、`速率`、`重置`、暂停切换规则分别验证
- 关键用例清单：
  - 初始随机：刷新页面，多次观察 A/B/C 种子位置变化（每次都应有三组）
  - 叠加显示：当 A/B/C 在演化过程中出现同格叠加时，能看到“多类型均匀分布”的显示效果
  - 独立演进：只画 A 的结构时，B/C 不应“凭空出现”；A 的演进只受 A 邻居影响
  - 规则共用：切换规则（例如某个预设）后，A/B/C 的演进都应按同一套 `B.../S...` 生效
  - 暂停约束：播放中无法改规则；暂停后可编辑规则（本阶段不支持棋盘编辑）
  - 环绕边界：结构跨越边界后能从另一侧继续出现（A/B/C 均一致）
- 通过标准：
  - `grid.cells` 支持 `0..7` 的 bitmask，并且演进后仍保持该范围
  - 三色分布渲染清晰、与 A/B/C 映射一致
  - A/B/C 演进互不影响但共用同一规则；规则切换仅在暂停时允许
  - `播放/暂停/速率/重置` 在多类型模式下行为正确且无明显卡顿

交付摘要口径（固定）：实现完成后，必须输出交付摘要，包含：
- 实际改动清单（按 repo 列出关键文件/模块）
- 自测步骤与结果
- 对照本节“通过标准”的逐条结论
- 已知风险/未决事项（如有必须列出）

约束：用户验收通过前，不更新 SOT，不归档 WIP。

## 4. SOT 更新清单（必须）
用户验收通过后，要把“最终事实”沉淀到 SOT（至少文件级，V1 不要求精确到小节）：

- `docs/sot/overview.md`：更新为“多类型多层元胞自动机（A/B/C）”、三色分布渲染、随机初始种子等事实
- `docs/sot/architecture.md`：更新数据结构为 bitmask、多类型独立演进语义、渲染约束与规则面板术语

## 5. 完成后归档动作（固定）
实现完成并完成基本自测后：
1) 输出交付摘要并请求用户验收
2) 用户验收通过后，按第 4 节更新 SOT
3) 更新第 6 节检查单（必须全勾）
4) 将整个目录从 `docs/wip/20260111-multitype-ca/` 移动到 `docs/archive/20260111-multitype-ca/`

## 6. WIP 检查单（必须全勾才能归档）
- [x] plan.md 已确认（PLAN 闸门已通过）
- [x] 代码改动已完成（IMPLEMENT 完成）
- [x] 基本自测已完成（记录命令/步骤与结果：`node --check`；以及演进 `cells` 范围断言）
- [x] 已输出交付摘要并且用户验收通过（VERIFY 闸门已通过）
- [x] SOT 已更新（`docs/sot/overview.md`、`docs/sot/architecture.md`）
- [x] 已归档：wip → archive（目录已移动）
