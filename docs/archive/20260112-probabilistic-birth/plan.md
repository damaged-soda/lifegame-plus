# 概率出生（可复现随机种子）技术变更计划（Plan）

## 0. 背景与目标（简短即可）
- 背景：
  - 当前方向规则体系中，“出生（空→活）”一旦命中即必然发生。
  - 新需求希望“生成/出生规则”为**概率触发**，并且要求**可复现**（给定随机种子可重复得到相同演化）。
- 目标：
  - 出生规则支持概率 `p`（每条规则独立拥有一个 `p`，默认 100%），并且：
    - 空格：对每一条**命中的出生规则**都进行一次独立抽样（“每条都抽”）
    - 只要任意一次抽样成功，则该类型在该格出生（同格同类型仍为二值，不叠加计数）
  - 死亡规则保持现有语义不变：
    - 活格默认存活，仅当命中“死亡（活→空）”规则才会死亡（无概率）
  - 可复现：
    - 增加“随机种子”输入框；同一 seed + 同一规则配置 + 同一操作序列下，演化结果可复现
    - 增加“重试”按钮：每次点击都会生成一个新的随机 seed，并用该 seed 重新随机初始化盘面（A/B/C 各一组）
  - 约束保持不变：
    - 纯前端（无后端）
    - 100×100
    - 边界：左右环绕、上下不环绕
    - A/B/C 三类型共用一套规则；各类型只看同类型邻居独立演化；同格可叠加
    - 调整 `p` 仅允许在暂停时进行（与规则面板一致）
- 非目标：
  - 暂不让死亡规则也具备概率
  - 暂不实现棋盘编辑/画笔
  - 暂不引入跨类型影响/转换

## 1. 影响范围（必须）
- 影响的 repo（来自 docmap，可多项）：lifegame-plus
- 影响的模块/目录/文件（按 repo 分组列出即可）：
  - repo: lifegame-plus
    - `src/lifegame-plus/engine/lifegame.js`（方向出生规则加入概率 + 注入可复现 RNG）
    - `src/lifegame-plus/web/index.html`（新增 seed 输入与“重试”按钮；出生规则卡片增加概率控件）
    - `src/lifegame-plus/web/main.js`（seed/RNG 管理；初始化随机与步进随机统一使用 seed；出生规则 `p` 状态与下发）
    - `src/lifegame-plus/web/style.css`（概率控件样式）
- 外部可见变化（如适用：API/CLI/配置/数据格式）：
  - 规则数据结构：出生规则新增 `p`（概率）；`stepDirectional` 增加可选 RNG 入参（用于可复现）

## 2. 方案与改动点（必须）
说明：实现将按批次推进；每批次写入前需先列出本批次改动文件/影响并征求确认。

### 2.1 概率出生语义（每条规则独立抽样）
- 仅对“出生规则（空→活）”增加概率：
  - `p` 取值范围：`0..1`（UI 用百分比展示/输入，内部转为 0..1）
  - 对同一空格、同一类型：
    - 遍历所有出生规则（固定顺序）
    - 对每条**匹配**规则调用一次 RNG 取样
    - 若 `rand < p` 则该规则“触发”；只要任一规则触发则出生
    - 为满足“每条都抽”并保证可复现：即使已确定出生，也继续对其余匹配规则取样（仅消耗 RNG，不再改变结果）

### 2.2 可复现 RNG（seeded PRNG）
- 采用一个简单确定性的 PRNG（例如 xorshift32 / mulberry32）实现 `nextFloat() -> [0,1)`。
- Web 侧维护 RNG 实例（由 seed 初始化），每次 `step` 持续消耗 RNG，保证“同 seed + 同规则 + 同操作”可复现。
- 初始化随机（A/B/C 三组种子放置位置）也改为使用同一个 RNG（不再使用 `Math.random`）。
- “重试”按钮：
  - 生成新的 seed（优先 `crypto.getRandomValues`）
  - 更新 seed 输入框显示
  - 以新 seed 重新初始化 RNG 与随机初始盘面，并进入暂停态
- 手动输入 seed：
  - 允许用户修改 seed（仅暂停时）
  - 触发方式：按回车/失焦后应用（具体交互在实现批次里细化）

### 2.3 引擎接口调整（MVP）
- `ruleSet` 扩展：
  - `birthRules` 的元素允许携带 `p`（缺省视为 1）
  - `deathRules` 不使用概率
- `stepDirectional` 扩展可选 RNG 参数（保持兼容）：
  - 旧调用：`stepDirectional(grid, ruleSet)`（无 RNG 时按确定性运行，且 `p` 视为 1 或使用 `Math.random` 不承诺可复现）
  - 新调用：`stepDirectional(grid, ruleSet, rng)`（用于可复现；Web 必须走该路径）

## 3. 自测与验收口径（必须，可执行）
- 本地自测步骤（命令/操作）：
  1) `python3 -m http.server 8000`
  2) 打开 `http://127.0.0.1:8000/src/lifegame-plus/web/`
  3) 暂停状态下，设置 seed 为固定值（例如 `123456`），点击/触发“用该 seed 初始化”（或等价操作）
  4) 设置某条出生规则 `p=50%`（其余保持 100%），点击 `播放`，观察演化若干秒后暂停
  5) 再次用同一 seed 重新初始化（不改规则配置），重复同样的播放/暂停操作，应得到相同的演化结果（可复现）
  6) 点击 `重试`（随机新 seed），盘面应变化（非复现）
- 关键用例清单：
  - 每条都抽：同一格命中多条出生规则时，概率叠加效果明显（比只抽一次更容易出生）
  - 默认 100%：所有出生规则 `p=100%` 时行为与当前版本一致（不引入随机差异）
  - 可复现：同 seed + 同规则配置 + 同操作序列，结果一致
  - 暂停约束：播放中禁用概率调整（与规则面板一致）
  - A/B/C 共用：三类型使用同一 RNG 流、同一规则集（仅邻居统计按类型隔离）
- 通过标准：
  - 出生规则支持每条 `p` 且可在 UI 调整（仅暂停）
  - 命中多条出生规则时“每条都抽”（而非只抽一次）
  - 提供 seed 输入框与重试随机 seed；可复现性用例成立
  - 其余约束不变（纯前端、100×100、左右环绕上下不环绕、多类型语义不变）

### 3.1 自测记录（实际执行）
- `node --check src/lifegame-plus/engine/lifegame.js`：通过
- `node --check src/lifegame-plus/web/main.js`：通过
- 可复现性验证（Node 脚本）：同 seed 运行 30 步 `cells` 一致；不同 seed 结果不同：通过
- 用户验收：通过（允许更新 SOT 并归档）

交付摘要口径（固定）：实现完成后，必须输出交付摘要，包含：
- 实际改动清单（按 repo 列出关键文件/模块）
- 自测步骤与结果
- 对照本节“通过标准”的逐条结论
- 已知风险/未决事项（如有必须列出）

约束：用户验收通过前，不更新 SOT，不归档 WIP。

## 4. SOT 更新清单（必须）
用户验收通过后，要把“最终事实”沉淀到 SOT：

- `docs/sot/overview.md`：补充“概率出生 + 可复现 seed + 重试”的使用说明
- `docs/sot/architecture.md`：更新方向规则数据结构（birth `p`、RNG 接口）与 `stepDirectional` 行为约束

## 5. 完成后归档动作（固定）
实现完成并完成基本自测后：
1) 输出交付摘要并请求用户验收
2) 用户验收通过后，按第 4 节更新 SOT
3) 更新第 6 节检查单（必须全勾）
4) 将整个目录从 `docs/wip/20260112-probabilistic-birth/` 移动到 `docs/archive/20260112-probabilistic-birth/`

## 6. WIP 检查单（必须全勾才能归档）
- [x] plan.md 已确认（PLAN 闸门已通过）
- [x] 代码改动已完成（IMPLEMENT 完成）
- [x] 基本自测已完成（记录命令/步骤与结果）
- [x] 已输出交付摘要并且用户验收通过（VERIFY 闸门已通过）
- [x] SOT 已更新（`docs/sot/overview.md`、`docs/sot/architecture.md`）
- [x] 已归档：wip → archive（目录已移动）
